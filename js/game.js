
å‡ç´š

å”ä½œ

åˆ†äº«
å¹«æˆ‘é€éå¾Œç«¯gasèˆ‡å‰ç«¯çš„HTMLï¼Œç”Ÿæˆå‰ç«¯çš„js
pasted_content.txt
æ–‡å­— Â· 30.82 KB
Lite
æ²’å•é¡Œï¼Œæˆ‘æœƒæ ¹æ“šæ‚¨æä¾›çš„å¾Œç«¯ GAS å’Œå‰ç«¯ HTML ä»£ç¢¼ï¼Œç‚ºæ‚¨ç”Ÿæˆå°æ‡‰çš„å‰ç«¯ JavaScriptã€‚è®“æˆ‘å…ˆæŸ¥çœ‹ä¸€ä¸‹æ‚¨ä¸Šå‚³çš„æ–‡ä»¶å…§å®¹ã€‚
ç›®å‰æ­£åˆ†æç”¨æˆ¶ä¸Šå‚³çš„å¾Œç«¯ GAS å’Œå‰ç«¯ HTML ä»£ç¢¼ï¼Œæº–å‚™ç”Ÿæˆç›¸æ‡‰çš„å‰ç«¯ JavaScript æ–‡ä»¶ã€‚

å·²è®€å–ä¸¦åˆ†æ GAS ä»£ç¢¼ï¼Œç™¼ç¾ä¸»è¦åŠŸèƒ½åŒ…æ‹¬æˆ¿é–“ç®¡ç†ã€ç©å®¶æ“ä½œã€éŠæˆ²æµç¨‹èˆ‡è³‡æ–™å­˜å–ï¼Œä¸‹ä¸€æ­¥æœƒæ•´ç†å‰ç«¯çµæ§‹ä¸¦é€²è¡Œè½‰è­¯ã€‚

Lite
æˆ‘å·²ç¶“åˆ†æäº†æ‚¨æä¾›çš„å¾Œç«¯ GAS ä»£ç¢¼ã€‚é€™æ˜¯ä¸€å€‹åŠŸèƒ½å®Œæ•´çš„ç‹¼äººæ®ºéŠæˆ²å¾Œç«¯ï¼ŒåŒ…å«ï¼š
æˆ¿é–“ç®¡ç†ï¼šå»ºç«‹ã€åŠ å…¥ã€é›¢é–‹æˆ¿é–“ï¼Œä»¥åŠæˆ¿é–“åˆ—è¡¨ã€‚
éŠæˆ²é‚è¼¯ï¼šåˆ†é…è§’è‰²ã€å¤œæ™šè¡Œå‹•ï¼ˆç‹¼äººæ®ºäººã€é è¨€å®¶æŸ¥é©—ã€é†«ç”Ÿå®ˆè­·ï¼‰ã€çµç®—å¤œæ™šã€æŠ•ç¥¨åŠçµç®—ã€å‹è² åˆ¤å®šã€‚
ç©å®¶ç³»çµ±ï¼šç™»å…¥ã€è¨»å†Šã€ç©å®¶çµ±è¨ˆæ•¸æ“šï¼ˆå‹ç‡ç­‰ï¼‰ã€‚
é€šè¨Šç³»çµ±ï¼šèŠå¤©å®¤åŠŸèƒ½ã€‚
ç®¡ç†åŠŸèƒ½ï¼šå¾Œå°ç®¡ç†æˆ¿é–“ã€‚
ç›®å‰æˆ‘åªæœ‰å¾Œç«¯ä»£ç¢¼ï¼Œç‚ºäº†ç”Ÿæˆæœ€ç²¾ç¢ºçš„å‰ç«¯ JavaScriptï¼Œæˆ‘éœ€è¦äº†è§£æ‚¨çš„ HTML çµæ§‹ï¼ˆä¾‹å¦‚æŒ‰éˆ•çš„ IDã€é¡¯ç¤ºå€åŸŸçš„ Class ç­‰ï¼‰ã€‚å¦‚æœæ‚¨æœ‰ HTML ä»£ç¢¼ï¼Œè«‹æä¾›çµ¦æˆ‘ï¼›å¦‚æœæ²’æœ‰ï¼Œæˆ‘å°‡æ ¹æ“šå¾Œç«¯é‚è¼¯ç‚ºæ‚¨æ¨æ–·ä¸¦ç”Ÿæˆä¸€å¥—é€šç”¨çš„å‰ç«¯ JS ä»£ç¢¼ã€‚æ‚¨å¸Œæœ›æˆ‘ç›´æ¥ç”Ÿæˆå—ï¼Ÿ
 HTMLåœ¨æª”æ¡ˆçš„å¾ŒåŠæ®µï¼Œç”Ÿæˆå¯ä»¥ç”¨æ–¼GITHUBçš„js
Lite
æ”¶åˆ°ï¼æˆ‘æœƒå¾æª”æ¡ˆå¾ŒåŠæ®µæå– HTML çµæ§‹ï¼Œä¸¦ç‚ºæ‚¨ç”Ÿæˆä¸€å€‹é©åˆéƒ¨ç½²åœ¨ GitHub Pagesï¼ˆé€é API å‘¼å« GASï¼‰çš„å‰ç«¯ JavaScript æª”æ¡ˆã€‚æˆ‘ç¾åœ¨å°±å»è®€å–å‰©é¤˜çš„å…§å®¹ã€‚
å·²åˆ†æHTMLçµæ§‹ï¼Œå°‡æ ¹æ“šå¾Œç«¯APIä¸¦ç”Ÿæˆå‰ç«¯scriptï¼Œå¯¦ç¾æˆ¿é–“å»ºç«‹ã€åŠ å…¥ã€éŠæˆ²æµç¨‹èˆ‡èŠå¤©å®¤åŠŸèƒ½ã€‚ä¸‹ä¸€æ­¥æœƒé€²è¡Œç¨‹å¼ç¢¼çµ„åˆã€‚

å·²å®Œæˆ config.jsã€api.jsã€game.js åŠ login.js çš„ç”Ÿæˆï¼Œæ¶µè“‹è¨­å®šã€APIèª¿ç”¨å’ŒéŠæˆ²é‚è¼¯ï¼Œæº–å‚™äº¤ä»˜å‰ç«¯æ•´åˆä½¿ç”¨ã€‚

å®Œæˆ login.js çš„ç”Ÿæˆï¼Œç¢ºèªå‰ç«¯é©—è­‰èˆ‡ç™»å…¥æµç¨‹å·²æ•´åˆï¼Œä¸‹ä¸€æ­¥å°‡æª¢æŸ¥æ•´é«”å‰ç«¯ä»£ç¢¼çš„ä¸€è‡´æ€§èˆ‡å¯é æ€§ã€‚

Lite
æˆ‘å·²ç¶“æ ¹æ“šæ‚¨çš„å¾Œç«¯ GAS ä»£ç¢¼å’Œ HTML çµæ§‹ï¼Œç”Ÿæˆäº†é©åˆéƒ¨ç½²åœ¨ GitHub Pages çš„å‰ç«¯ JavaScript æª”æ¡ˆã€‚
æª”æ¡ˆèªªæ˜ï¼š
config.jsï¼šè¨­å®šæª”ã€‚è«‹å‹™å¿…å°‡å…¶ä¸­çš„ API_URL æ›¿æ›ç‚ºæ‚¨ç™¼å¸ƒçš„ GAS Web App ç¶²å€ã€‚
api.jsï¼šå°è£äº†æ‰€æœ‰èˆ‡ GAS é€šè¨Šçš„å‡½æ•¸ï¼Œè™•ç† fetch è«‹æ±‚ã€‚
game.jsï¼šæ ¸å¿ƒéŠæˆ²é‚è¼¯ï¼ŒåŒ…å«æˆ¿é–“è¼ªè©¢ã€ç©å®¶åˆ—è¡¨æ¸²æŸ“ã€å¤œæ™šè¡Œå‹•èˆ‡æŠ•ç¥¨è™•ç†ã€‚
login.jsï¼šè™•ç†ç™»å…¥èˆ‡è¨»å†Šé é¢çš„é‚è¼¯ã€‚
éƒ¨ç½²å»ºè­°ï¼š
CORS è™•ç†ï¼šç”±æ–¼ GitHub Pages èˆ‡ GAS ç¶²åŸŸä¸åŒï¼Œè«‹ç¢ºä¿æ‚¨çš„ GAS doPost å‡½æ•¸å›å‚³æ­£ç¢ºçš„ ContentService æ ¼å¼ï¼ˆæ‚¨çš„å¾Œç«¯ä»£ç¢¼å·²ç¶“è™•ç†äº†é€™ä¸€é»ï¼‰ã€‚
HTML å¼•ç”¨ï¼šè«‹ç¢ºä¿æ‚¨çš„ HTML æª”æ¡ˆä¸­æ­£ç¢ºå¼•ç”¨äº†é€™äº› JS æª”æ¡ˆï¼Œé †åºæ‡‰ç‚ºï¼š
HTML
<script src="js/config.js"></script>
<script src="js/api.js"></script>
<script src="js/game.js"></script>
<!-- å¦‚æœæ˜¯ç™»å…¥é é¢å‰‡å¼•ç”¨ login.js -->
å®‰å…¨æ€§ï¼šç›®å‰çš„ ADMIN_PASSWORD æ˜¯å¯«æ­»åœ¨å¾Œç«¯çš„ï¼Œå»ºè­°åœ¨æ­£å¼ä½¿ç”¨æ™‚ä¿®æ”¹ã€‚
æ‚¨å¯ä»¥ç›´æ¥ä¸‹è¼‰é™„ä»¶ä¸­çš„æª”æ¡ˆä¸¦æ”¾å…¥æ‚¨çš„ GitHub å°ˆæ¡ˆç›®éŒ„ä¸­ã€‚
config.js
ç¨‹å¼ç¢¼ Â· 443 B
api.js
ç¨‹å¼ç¢¼ Â· 2.74 KB
game.js
ç¨‹å¼ç¢¼ Â· 11.19 KB
login.js
ç¨‹å¼ç¢¼ Â· 1.04 KB

æŸ¥çœ‹æ­¤ä»»å‹™ä¸­çš„æ‰€æœ‰æª”æ¡ˆ
ä»»å‹™å·²å®Œæˆ
é€™å€‹çµæœæ€éº¼æ¨£ï¼Ÿ
å»ºè­°è¿½å•
å‚³é€è¨Šæ¯çµ¦ Manus

game.js
/**
 * ç‹¼äººæ®ºéŠæˆ² å‰ç«¯æ ¸å¿ƒé‚è¼¯
 */

let currentState = {
  playId: localStorage.getItem(CONFIG.STORAGE_KEY.PLAY_ID),
  playerName: localStorage.getItem(CONFIG.STORAGE_KEY.PLAYER_NAME),
  playerId: localStorage.getItem(CONFIG.STORAGE_KEY.PLAYER_ID),
  roomId: localStorage.getItem(CONFIG.STORAGE_KEY.ROOM_ID),
  roomData: null,
  pollTimer: null
};

// åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
  initUI();
  checkLoginStatus();
});

function initUI() {
  // ç¶å®šæŒ‰éˆ•äº‹ä»¶
  document.getElementById('createRoomBtn')?.addEventListener('click', handleCreateRoom);
  document.getElementById('joinRoomBtn')?.addEventListener('click', handleJoinRoom);
  document.getElementById('refreshRoomListBtn')?.addEventListener('click', refreshRoomList);
  document.getElementById('leaveRoomBtn')?.addEventListener('click', handleLeaveRoom);
  document.getElementById('sendChatBtn')?.addEventListener('click', handleSendChat);
  document.getElementById('logoutBtn')?.addEventListener('click', handleLogout);
  document.getElementById('playerInfoBtn')?.addEventListener('click', showPlayerInfo);
  document.getElementById('closePlayerInfoBtn')?.addEventListener('click', () => {
    document.getElementById('playerInfoModal').style.display = 'none';
  });
  
  // èŠå¤©å®¤ Enter é€å‡º
  document.getElementById('chatInput')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleSendChat();
  });
}

function checkLoginStatus() {
  if (!currentState.playId) {
    // å¦‚æœæ²’æœ‰ç™»å…¥è³‡è¨Šï¼Œè·³è½‰åˆ°ç™»å…¥é ï¼ˆå‡è¨­ç™»å…¥é‚è¼¯åœ¨ login.htmlï¼‰
    // é€™è£¡ç°¡å–®è™•ç†ï¼šå¦‚æœåœ¨å¤§å»³ä½†æ²’ç™»å…¥ï¼Œæç¤ºä¸¦å°å‘
    if (window.location.pathname.includes('index.html')) {
      alert('è«‹å…ˆç™»å…¥');
      window.location.href = 'login.html';
    }
  } else {
    document.getElementById('playerName').textContent = currentState.playerName;
    if (currentState.roomId) {
      enterRoomUI(currentState.roomId);
    } else {
      enterLobbyUI();
    }
  }
}

// --- å¤§å»³é‚è¼¯ ---

async function enterLobbyUI() {
  document.getElementById('lobbyArea').style.display = 'block';
  document.getElementById('gameArea').style.display = 'none';
  refreshRoomList();
}

async function refreshRoomList() {
  const listEl = document.getElementById('roomList');
  try {
    const rooms = await API.listRooms();
    listEl.innerHTML = '';
    if (rooms.length === 0) {
      listEl.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ç›®å‰æ²’æœ‰æˆ¿é–“</div>';
      return;
    }
    rooms.forEach(room => {
      const div = document.createElement('div');
      div.className = 'room-item'; // å‡è¨­ CSS æœ‰å®šç¾©
      div.style = 'padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;';
      div.innerHTML = `
        <div>
          <strong>æˆ¿è™Ÿ: ${room.id}</strong> <br>
          <small>æˆ¿ä¸»: ${room.hostName} | äººæ•¸: ${room.playerCount}</small>
        </div>
        <button class="btn-success" onclick="handleJoinRoomById('${room.id}')">åŠ å…¥</button>
      `;
      listEl.appendChild(div);
    });
  } catch (err) {
    listEl.innerHTML = '<div style="color: red; padding: 20px;">è¼‰å…¥å¤±æ•—</div>';
  }
}

async function handleCreateRoom() {
  const customId = document.getElementById('customRoomId').value;
  try {
    const result = await API.createRoom(currentState.playId, customId);
    saveRoomSession(result.roomId, result.playerId);
    enterRoomUI(result.roomId);
  } catch (err) {
    document.getElementById('createError').textContent = err.message;
  }
}

async function handleJoinRoom() {
  const roomId = document.getElementById('joinRoomId').value.toUpperCase();
  handleJoinRoomById(roomId);
}

async function handleJoinRoomById(roomId) {
  try {
    const result = await API.joinRoom(roomId, currentState.playId);
    saveRoomSession(roomId, result.playerId);
    enterRoomUI(roomId);
  } catch (err) {
    alert('åŠ å…¥å¤±æ•—: ' + err.message);
  }
}

// --- éŠæˆ²æˆ¿é–“é‚è¼¯ ---

function enterRoomUI(roomId) {
  currentState.roomId = roomId;
  document.getElementById('lobbyArea').style.display = 'none';
  document.getElementById('gameArea').style.display = 'block';
  document.getElementById('roomId').textContent = roomId;
  
  startPolling();
}

function saveRoomSession(roomId, playerId) {
  currentState.roomId = roomId;
  currentState.playerId = playerId;
  localStorage.setItem(CONFIG.STORAGE_KEY.ROOM_ID, roomId);
  localStorage.setItem(CONFIG.STORAGE_KEY.PLAYER_ID, playerId);
}

function startPolling() {
  if (currentState.pollTimer) clearInterval(currentState.pollTimer);
  updateRoomState();
  currentState.pollTimer = setInterval(updateRoomState, CONFIG.POLL_INTERVAL_MS);
}

async function updateRoomState() {
  if (!currentState.roomId) return;
  try {
    const data = await API.getRoomState(currentState.roomId, currentState.playerId);
    currentState.roomData = data;
    renderRoom(data);
  } catch (err) {
    console.error('è¼ªè©¢å¤±æ•—', err);
    if (err.message.includes('not found')) {
      handleLeaveRoom();
    }
  }
}

function renderRoom(data) {
  // 1. æ¸²æŸ“ç©å®¶åˆ—è¡¨
  const playerListEl = document.getElementById('playerList');
  playerListEl.innerHTML = '';
  
  const players = Object.values(data.players);
  players.forEach(p => {
    const div = document.createElement('div');
    div.className = `player-card ${p.alive ? '' : 'dead'}`;
    div.style = `padding: 10px; border: 1px solid #ddd; border-radius: 8px; text-align: center; background: ${p.id === currentState.playerId ? '#fff9c4' : '#fff'}`;
    div.innerHTML = `
      <div class="avatar">${p.avatar ? `<img src="${p.avatar}" width="40">` : 'ğŸ‘¤'}</div>
      <div>${p.name} ${p.id === data.hostId ? 'ğŸ‘‘' : ''}</div>
      <div style="font-size: 12px; color: ${p.alive ? 'green' : 'red'}">${p.alive ? 'å­˜æ´»' : 'æ­»äº¡'}</div>
    `;
    playerListEl.appendChild(div);
  });

  // 2. è§’è‰²é¡¯ç¤º
  const me = data.players[currentState.playerId];
  document.getElementById('myRole').textContent = me?.role || 'ç­‰å¾…åˆ†é…';

  // 3. èŠå¤©å®¤
  renderChat(data.chat);

  // 4. æ ¹æ“šéšæ®µé¡¯ç¤ºè¡Œå‹•
  const nightDiv = document.getElementById('nightActionDiv');
  const voteDiv = document.getElementById('voteDiv');
  
  nightDiv.style.display = 'none';
  voteDiv.style.display = 'none';

  if (data.phase === 'night' && me?.alive) {
    renderNightActions(data, me);
  } else if (data.phase === 'day' && me?.alive) {
    renderVoteActions(data, me);
  } else if (data.phase === 'lobby' && currentState.playerId === data.hostId) {
    // æˆ¿ä¸»é¡¯ç¤ºé–‹å§‹æŒ‰éˆ•
    if (players.length >= 4) { // å‡è¨­æœ€å°‘ 4 äºº
      const startBtn = document.createElement('button');
      startBtn.className = 'btn-primary';
      startBtn.style = 'width: 100%; margin-top: 10px;';
      startBtn.textContent = 'åˆ†é…è§’è‰²ä¸¦é–‹å§‹';
      startBtn.onclick = () => API.assignRoles(data.id, currentState.playerId);
      playerListEl.appendChild(startBtn);
    }
  }
}

function renderChat(chats) {
  const chatBox = document.getElementById('chatBox');
  const isAtBottom = chatBox.scrollHeight - chatBox.scrollTop <= chatBox.clientHeight + 50;
  
  chatBox.innerHTML = chats.map(c => {
    if (c.system) return `<div class="chat-msg system">ğŸ“¢ ${c.text}</div>`;
    return `<div class="chat-msg"><strong>${c.name}:</strong> ${c.text}</div>`;
  }).join('');

  if (isAtBottom) chatBox.scrollTop = chatBox.scrollHeight;
}

function renderNightActions(data, me) {
  const div = document.getElementById('nightActionDiv');
  const info = document.getElementById('nightActionInfo');
  const targets = document.getElementById('nightTargets');
  
  div.style.display = 'block';
  targets.innerHTML = '';

  let actionType = '';
  if (me.role === 'werewolf') {
    info.textContent = 'ä½ æ˜¯ç‹¼äººï¼Œè«‹é¸æ“‡è¦æ®ºå®³çš„ç›®æ¨™ï¼š';
    actionType = 'kill';
  } else if (me.role === 'seer') {
    info.textContent = 'ä½ æ˜¯é è¨€å®¶ï¼Œè«‹é¸æ“‡è¦æŸ¥é©—çš„ç›®æ¨™ï¼š';
    actionType = 'check';
  } else if (me.role === 'doctor') {
    info.textContent = 'ä½ æ˜¯é†«ç”Ÿï¼Œè«‹é¸æ“‡è¦å®ˆè­·çš„ç›®æ¨™ï¼š';
    actionType = 'save';
  } else {
    info.textContent = 'å¤©é»‘è«‹é–‰çœ¼ï¼Œç­‰å¾…å…¶ä»–è§’è‰²è¡Œå‹•...';
    return;
  }

  // æˆ¿ä¸»é¡¯ç¤ºçµç®—æŒ‰éˆ•
  if (currentState.playerId === data.hostId) {
    const resolveBtn = document.createElement('button');
    resolveBtn.className = 'btn-warning';
    resolveBtn.textContent = 'çµæŸå¤œæ™š';
    resolveBtn.onclick = () => API.resolveNight(data.id, currentState.playerId);
    targets.appendChild(resolveBtn);
  }

  Object.values(data.players).forEach(p => {
    if (p.alive && p.id !== currentState.playerId) {
      const btn = document.createElement('button');
      btn.className = 'btn-outline';
      btn.textContent = p.name;
      btn.onclick = async () => {
        try {
          await API.submitNightAction(data.id, currentState.playerId, { type: actionType, targetId: p.id });
          alert('è¡Œå‹•å·²æäº¤');
        } catch (err) { alert(err.message); }
      };
      targets.appendChild(btn);
    }
  });
}

function renderVoteActions(data, me) {
  const div = document.getElementById('voteDiv');
  const targets = document.getElementById('voteTargets');
  div.style.display = 'block';
  targets.innerHTML = '';

  // æˆ¿ä¸»é¡¯ç¤ºçµç®—æŒ‰éˆ•
  if (currentState.playerId === data.hostId) {
    const resolveBtn = document.getElementById('submitVoteBtn');
    resolveBtn.textContent = 'çµç®—æŠ•ç¥¨çµæœ';
    resolveBtn.onclick = () => API.resolveVotes(data.id, currentState.playerId);
  }

  Object.values(data.players).forEach(p => {
    if (p.alive) {
      const btn = document.createElement('button');
      btn.className = 'btn-outline';
      btn.textContent = p.name;
      btn.onclick = async () => {
        try {
          await API.submitVote(data.id, currentState.playerId, p.id);
          alert('å·²æŠ•ç¥¨çµ¦ ' + p.name);
        } catch (err) { alert(err.message); }
      };
      targets.appendChild(btn);
    }
  });
}

async function handleSendChat() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text || !currentState.roomId) return;
  
  try {
    await API.postChat(currentState.roomId, currentState.playerId, text);
    input.value = '';
  } catch (err) { alert('ç™¼é€å¤±æ•—'); }
}

async function handleLeaveRoom() {
  if (currentState.roomId) {
    try { await API.leaveRoom(currentState.roomId, currentState.playerId); } catch(e){}
  }
  clearInterval(currentState.pollTimer);
  currentState.roomId = null;
  currentState.playerId = null;
  localStorage.removeItem(CONFIG.STORAGE_KEY.ROOM_ID);
  localStorage.removeItem(CONFIG.STORAGE_KEY.PLAYER_ID);
  enterLobbyUI();
}

async function showPlayerInfo() {
  const modal = document.getElementById('playerInfoModal');
  const content = document.getElementById('playerInfoContent');
  modal.style.display = 'block';
  content.textContent = 'è¼‰å…¥ä¸­...';
  
  try {
    const stats = await API.getPlayerStats(currentState.playId);
    content.innerHTML = `
      <p>åç¨±: ${stats.name}</p>
      <p>å‹å ´: ${stats.wins}</p>
      <p>æ•—å ´: ${stats.losses}</p>
      <p>å‹ç‡: ${stats.winRate}%</p>
    `;
  } catch (err) {
    content.textContent = 'è¼‰å…¥å¤±æ•—: ' + err.message;
  }
}

function handleLogout() {
  localStorage.clear();
  window.location.href = 'login.html';
}
